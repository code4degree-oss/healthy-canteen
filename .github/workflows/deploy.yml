# =============================================================================
# Deploy to Production â€” The Healthy Canteen
# =============================================================================
# Purpose : Automatically deploy to the VPS after CI passes on main.
# Flow:
#   1. CI job runs first (build + type-check frontend & backend)
#   2. Only if CI passes â†’ SSH into the server and deploy
#   3. After deploy â†’ run a health-check curl to verify the app is alive
#
# Required GitHub Secrets (Settings â†’ Secrets â†’ Actions):
#   HOST      â€” VPS IP address or hostname (e.g. 123.45.67.89)
#   USERNAME  â€” SSH user on the server   (e.g. deploy)
#   SSH_KEY   â€” Private SSH key for that user
#   DEPLOY_DIRâ€” (optional) Override the deploy directory, default /var/www/the-healthy-canteen
# =============================================================================

name: Deploy to Production

# â”€â”€ Trigger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Only deploy on pushes to main â€” never on pull requests.
# PRs are validated by ci.yml; this workflow ships the result.
on:
  push:
    branches: ["main"]

# â”€â”€ Concurrency â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Prevent multiple deploys from running at the same time.
# If a new push arrives while a deploy is in progress, the old deploy
# is cancelled so the server always ends up on the latest commit.
concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 1: CI â€” Build & Verify (reuse the same steps as ci.yml)
  # This ensures we never deploy code that doesn't compile.
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ci:
    name: CI â€” Build & Verify
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json

      - name: Install & build frontend
        run: |
          npm ci
          npm run build

      - name: Install & build backend
        working-directory: ./backend
        run: |
          npm ci
          npm run build

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 2: Deploy â€” SSH into the server and update the running application
  # Only runs after the CI job succeeds (`needs: ci`).
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  deploy:
    name: Deploy to VPS
    needs: ci                        # â† Gate: only deploy if CI passes
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: production          # Shows deploy status badge in GitHub

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          # The deploy directory defaults to /var/www/the-healthy-canteen
          # Override with the DEPLOY_DIR secret if your path differs.
          script: |
            set -e  # Exit immediately if any command fails

            DEPLOY_DIR="${{ secrets.DEPLOY_DIR }}"
            DEPLOY_DIR="${DEPLOY_DIR:-/var/www/the-healthy-canteen}"

            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  ğŸš€ Starting deployment...               â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            # â”€â”€ 1. Navigate to project â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            cd "$DEPLOY_DIR"

            # â”€â”€ 2. Pull latest code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "â†’ Pulling latest code from main..."
            git pull origin main

            # â”€â”€ 3. Backend: Install & Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "â†’ Installing backend dependencies..."
            cd backend
            npm ci --production=false   # Need devDeps for `tsc`
            echo "â†’ Building backend (TypeScript â†’ JavaScript)..."
            npm run build

            # Prune devDependencies after build to keep the server lean
            npm prune --production
            cd ..

            # â”€â”€ 4. Frontend: Install & Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "â†’ Installing frontend dependencies..."
            npm ci

            # Create .env.production for the build to use relative API paths and correct Google Client ID
            echo "VITE_API_URL=/api" > .env.production
            echo "VITE_GOOGLE_CLIENT_ID=475667640474-5ihm207nukv7nhjqs2uqraue0dufo8mb.apps.googleusercontent.com" >> .env.production

            echo "â†’ Building frontend (Vite â†’ dist/)..."
            npm run build

            # â”€â”€ 5. Restart the backend via PM2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # `pm2 startOrRestart` handles both fresh starts and restarts.
            # --update-env ensures any new environment variables are picked up.
            echo "â†’ Restarting backend with PM2..."
            if pm2 describe hct-backend > /dev/null 2>&1; then
              NODE_ENV=production pm2 restart hct-backend --update-env
            else
              cd backend
              NODE_ENV=production pm2 start dist/server.js --name "hct-backend"
              cd ..
            fi

            # â”€â”€ 6. Health Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Wait a few seconds for the server to boot, then verify it
            # responds with HTTP 200. This catches startup crashes early.
            echo "â†’ Running health check..."
            sleep 3
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/api/menu || echo "000")

            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Health check passed (HTTP $HTTP_STATUS)"
            else
              echo "âš ï¸  Health check returned HTTP $HTTP_STATUS"
              echo "   Check logs with: pm2 logs hct-backend --lines 50"
              exit 1
            fi

            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âœ… Deployment complete!                  â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
